import sys
import pandas as pd
import os
import glob



"""
filter_by_functional_element.py
@ given a file of positions of functional elements (e.g. gene bodies, promoters, enhancers) subset the raw posterior data to only include windows overlapping these positions
@ do this for one chromosome
"""

def subset(raw_dir, chrom_name, pos_to_keep_l, out_dir):
    fns = glob.glob(os.path.join(raw_dir, '*' + chrom_name + '_posterior.txt'))
    print(fns)
    for sample_fn in fns:
        sample_df = pd.read_csv(sample_fn, sep = '\t', skiprows=1)
        sample_df = sample_df.iloc[pos_to_keep_l]
        new_name = sample_fn.split('/')[-1].split('.')[0] + '_only_gene_bodies.tsv'
        sample_df.to_csv(os.path.join(out_dir, new_name), sep='\t')

def get_positions(func_el_fn, chrom_name):
    func_df = pd.read_csv(func_el_fn, sep = '\t')
    # keep only this chrom
    func_df = func_df[func_df['seqname'] == chrom_name]
    start_bp_l = func_df['start'].to_list()
    end_bp_l = func_df['end'].to_list()
    # convert each start and end bp into window, rounding down for start and up for end
    start_window_l = list(map(lambda x: x//200, start_bp_l))
    end_window_l = list(map(lambda x: x//200 + 1, end_bp_l))
    # create a list of all numbers between each start_window_l[i] and end_window_l[i]
    all_indices_l = []
    for start, end in zip(start_window_l, end_window_l):
        all_indices_l.extend([pos for pos in range(start, end + 1)])
    return all_indices_l

def main():
    raw_dir = sys.argv[1]
    func_el_fn = sys.argv[2]
    chrom_num = sys.argv[3]
    out_dir = sys.argv[4]
    chrom_name = 'chr' + str(chrom_num)
    pos_to_keep_l = get_positions(func_el_fn, chrom_name)
    subset(raw_dir, chrom_name, pos_to_keep_l, out_dir)
# make list of tuples where the tuples are start and end locations of the fucntional element, converted into 200bp window (rounding up to include more than necessary where rounding is needed)
# turn this list into a list of every position we want to keep, then use .iloc to select these rows from the raw_df


main()
